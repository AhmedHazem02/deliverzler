rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // السماح بالقراءة والكتابة للمستخدمين المصرحين فقط
    match /orders/{orderId} {
      // قراءة الطلب
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.driverId ||
                      request.auth.uid == resource.data.userId ||
                      isAdmin());

      // تحديث حالة الطلب
      allow update: if request.auth != null && 
                       (isDriver(orderId) ||
                        isAdmin()) &&
                       hasValidFields(['status', 'updatedAt', 'location', 'notes']);

      // إنشاء طلب جديد
      allow create: if request.auth != null && 
                       (request.auth.uid == request.resource.data.userId ||
                        isAdmin());

      // حذف الطلب (فقط المالك أو الأدمن)
      allow delete: if request.auth != null && 
                       (request.auth.uid == resource.data.userId ||
                        isAdmin());
    }

    // إعدادات التطبيق
    match /settings/app_config {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ملف تعريف المستخدم
    match /users/{userId} {
      allow read: if request.auth != null && 
                     (request.auth.uid == userId ||
                      isAdmin());

      allow update: if request.auth != null && 
                       request.auth.uid == userId;

      allow write: if isAdmin();
    }

    // ملف تعريف السائق
    match /drivers/{driverId} {
      allow read: if request.auth != null && 
                     (request.auth.uid == driverId ||
                      isAdmin());

      allow update: if request.auth != null && 
                       request.auth.uid == driverId;

      allow write: if isAdmin();
    }

    // المناطق النشطة
    match /active_zones/{zoneId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // معدلات العمولة
    match /commission_rates/{rateId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // الإشعارات
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;

      allow create: if isAdmin();
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }

    // الدوال المساعدة
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    function isDriver(orderId) {
      return request.auth.uid == get(/databases/$(database)/documents/orders/$(orderId)).data.driverId;
    }

    function hasValidFields(fields) {
      let requestFields = request.resource.data.keys();
      return requestFields.hasAll(fields);
    }
  }
}
